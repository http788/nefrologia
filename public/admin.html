<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CINYDMC - Administración</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* PALETA "AIRE & VIDA" (Turquesa Clínico) */
            --bg-body: #e0f2f1;       
            --sidebar-bg: #004d40;    
            --sidebar-hover: #00695c; 
            --accent: #26a69a;        
            --text-dark: #263238;     
            --card-bg: #ffffff;       
        }

        body { background-color: var(--bg-body); color: var(--text-dark); font-family: 'Segoe UI', Roboto, sans-serif; }
        h1, h2, h3, h4, h5, h6 { color: var(--sidebar-bg); font-weight: 700; }
        
        /* SIDEBAR */
        .sidebar { background: linear-gradient(160deg, var(--sidebar-bg) 0%, #00251a 100%); min-height: 100vh; color: white; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .nav-link { color: rgba(255,255,255,0.85); padding: 12px 20px; transition: 0.3s; border-radius: 0 50px 50px 0; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { background-color: var(--accent); color: white; padding-left: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .nav-link i { margin-right: 10px; font-size: 1.1rem; }
        
        /* LOGO BLANCO */
        .hospital-logo { font-size: 3.5rem; color: #ffffff; text-shadow: 0 0 15px rgba(255,255,255,0.4); }

        /* CARDS */
        .card-panel { background-color: var(--card-bg); border-radius: 15px; border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.05); padding: 30px; margin-bottom: 25px; height: 100%; }
        
        /* FORMULARIOS */
        .form-control, .form-select { background-color: #f1f8e9; border: 1px solid #c5e1a5; color: var(--text-dark); border-radius: 8px; padding: 10px; }
        .form-control:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(38, 166, 154, 0.2); background-color: white; }

        /* BOTONES */
        .btn-turquesa { background: linear-gradient(135deg, var(--accent), #00897b); color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: 600; transition: 0.3s; }
        .btn-turquesa:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 137, 123, 0.4); color: white; }
        
        /* TABLAS */
        .table-custom thead th { background-color: #b2dfdb !important; color: var(--sidebar-bg); border-bottom: 2px solid var(--accent); padding: 15px; }
        .table-custom td { vertical-align: middle; background: white; border-bottom: 1px solid #e0f2f1; padding: 12px; }
        
        /* MODALES & IMPRESIÓN */
        .modal-header { background-color: var(--sidebar-bg); color: white; }
        .btn-close-white { filter: invert(1); }
        
        /* Estilos de Ficha Completa (Ver Paciente/Personal) */
        .detail-label { font-weight: bold; color: var(--sidebar-hover); font-size: 0.85rem; text-transform: uppercase; display: block; margin-top: 8px;}
        .detail-value { font-size: 1rem; color: #333; margin-bottom: 5px; display: block; border-bottom: 1px solid #e0f2f1; padding-bottom: 5px; background: #fafafa; padding: 5px; border-radius: 4px;}

        /* Estilos Diálisis */
        .label-clinical { font-size: 0.75rem; text-transform: uppercase; color: #546e7a; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 2px; display: block; }
        .data-value { font-size: 1rem; font-weight: 600; color: #263238; display: block; padding: 5px; background: #f1f8e9; border-radius: 4px; border: 1px solid #c5e1a5; }
        .section-title { color: #004d40; border-bottom: 2px solid #26a69a; padding-bottom: 5px; margin-bottom: 15px; font-weight: bold; }

        @media print {
            body * { visibility: hidden; }
            #modalControlDialisis, #modalControlDialisis * { visibility: visible; }
            #modalControlDialisis { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .modal-footer, .btn-close { display: none !important; }
            .modal-body { background-color: white !important; color: black !important; }
        }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; top: 0; z-index: 1050; width: 280px; height: 100%; transition: 0.3s; }
            .sidebar.show { left: 0; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040; }
            .overlay.show { display: block; }
        }
    </style>
</head>
<body>

<div class="d-md-none p-3 bg-white shadow-sm d-flex justify-content-between align-items-center sticky-top">
    <button class="btn text-secondary" onclick="toggleMenu()"><i class="bi bi-list fs-1"></i></button>
    <h5 class="m-0 fw-bold" style="color: var(--sidebar-bg);">CINYDMC</h5>
    <i class="bi bi-hospital-fill fs-2" style="color: var(--accent);"></i>
</div>
<div class="overlay" id="mobileOverlay" onclick="toggleMenu()"></div>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse p-3">
            <div class="text-center mb-5 pt-4">
                <i class="bi bi-hospital-fill hospital-logo"></i>
                <h5 class="fw-bold mt-2 text-white">CINYDMC</h5>
                <small class="d-block opacity-75 small text-white">Centro Integral de Nefrología<br>y Diálisis Migdalis Cepeda</small>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#" onclick="showSection('estadisticas', this)"><i class="bi bi-pie-chart-fill"></i> Panel General</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('dialisis', this)"><i class="bi bi-activity"></i> Pacientes Diálisis</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('registro-paciente', this)"><i class="bi bi-person-plus-fill"></i> Registrar Paciente</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('lista-pacientes', this)"><i class="bi bi-people-fill"></i> Directorio Pacientes</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('recetas', this)"><i class="bi bi-send-fill"></i> Enviar Resultados</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('nuevo-personal', this)"><i class="bi bi-person-badge-fill"></i> Registrar Personal</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('lista-personal', this)"><i class="bi bi-card-list"></i> Nómina Personal</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('inventario', this)"><i class="bi bi-box-seam-fill"></i> Inventario</a></li>
                <li class="nav-item mt-4 pt-3 border-top border-white-50">
                    <a class="nav-link text-danger fw-bold" href="/logout" style="background: rgba(255,255,255,0.9) !important;">
                        <i class="bi bi-box-arrow-left text-danger"></i> Salir del Sistema
                    </a>
                </li>
            </ul>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            
            <div id="estadisticas-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Tablero Clínico</h2>
                    <button class="btn btn-turquesa" onclick="cargarDatosEstadisticos()"><i class="bi bi-arrow-clockwise me-2"></i>Actualizar Data</button>
                </div>
                
                <div class="row g-4 mb-4">
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card-panel text-center">
                            <h5 class="mb-3">Distribución por Género</h5>
                            <div style="position: relative; height: 250px;"><canvas id="chartSexo"></canvas></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card-panel text-center">
                            <h5 class="mb-3">Rango Etario</h5>
                            <div style="position: relative; height: 250px;"><canvas id="chartEdad"></canvas></div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-4">
                        <div class="card-panel text-center">
                            <h5 class="mb-3">Estadío Renal (ERC vs IRC)</h5>
                            <div style="position: relative; height: 250px;"><canvas id="chartEstadio"></canvas></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card-panel">
                            <h5 class="mb-3">Curva de Crecimiento: <span class="text-success">ERC (Tratamiento)</span> vs <span class="text-danger">IRC (Diálisis)</span></h5>
                            <div style="height: 400px; width: 100%; position: relative;">
                                <canvas id="chartHistoria"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dialisis-section" style="display:none;">
                <h3 class="text-danger mb-4"><i class="bi bi-heart-pulse-fill me-2"></i>Pacientes en Unidad de Diálisis (IRC)</h3>
                <div class="card-panel">
                    <div class="table-responsive">
                        <table class="table table-custom table-hover align-middle">
                            <thead><tr><th>Paciente</th><th>Cédula</th><th>Bioquímica Reciente</th><th class="text-end">Ficha Técnica</th></tr></thead>
                            <tbody id="tabla-dialisis"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="registro-paciente-section" style="display:none;">
                <h3><i class="bi bi-folder-plus me-2"></i>Nueva Admisión</h3>
                <div class="card-panel mt-3">
                    <form onsubmit="registrarPaciente(event)" autocomplete="off">
                        <h5 class="text-secondary border-bottom pb-2 mb-3">Datos Personales</h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4"><label>Nombre Completo</label><input type="text" class="form-control" name="nombre" required></div>
                            <div class="col-md-4"><label>Cédula</label><input type="text" class="form-control" name="cedula" required></div>
                            <div class="col-md-4"><label>Sexo</label><select class="form-select" name="sexo" id="inputSexo" onchange="calcTFG()" required><option>Masculino</option><option>Femenino</option></select></div>
                            <div class="col-md-4"><label>Nacimiento</label><input type="date" class="form-control" name="fecha_nacimiento" required></div>
                            <div class="col-md-4"><label>Email</label><input type="email" class="form-control" name="email" required></div>
                            <div class="col-md-4"><label>Contraseña</label><input type="password" class="form-control" name="password" required></div>
                        </div>

                        <h5 class="text-secondary border-bottom pb-2 mb-3">Clínica & TFG</h5>
                        <div class="row g-3 align-items-end mb-4 bg-light p-3 rounded border">
                            <div class="col-md-3"><label>Edad (Años)</label><input type="number" class="form-control" id="inputEdad" oninput="calcTFG()" required></div>
                            <div class="col-md-3"><label>Urea</label><input type="number" step="0.01" class="form-control" name="urea" required></div>
                            <div class="col-md-3"><label>Creatinina</label><input type="number" step="0.01" class="form-control" name="creatinina" id="inputCreatinina" oninput="calcTFG()" required></div>
                            <div class="col-md-3">
                                <label>Estadío (Auto)</label>
                                <input type="text" class="form-control fw-bold text-center text-white" style="background-color: var(--accent);" name="estadio" id="inputEstadio" readonly>
                            </div>
                            <div class="col-12 text-end"><small id="resTFG" class="fw-bold text-success"></small></div>
                        </div>
                        
                        <div class="row g-3">
                             <div class="col-md-6"><label>Teléfono</label><input type="tel" class="form-control" name="telefono"></div>
                             <div class="col-md-6"><label>Emergencia</label><input type="text" class="form-control border-danger" name="contacto_emergencia"></div>
                             <div class="col-12"><label>Dirección</label><input type="text" class="form-control" name="direccion"></div>
                             <div class="col-12"><label>Comorbilidades / Notas</label><textarea class="form-control" name="comorbilidades" rows="2"></textarea></div>
                             <div class="col-12"><button class="btn btn-turquesa w-100 py-3 mt-2">REGISTRAR PACIENTE</button></div>
                        </div>
                    </form>
                </div>
            </div>

            <div id="lista-pacientes-section" style="display:none;">
                <div class="d-flex justify-content-between mb-3"><h3>Directorio de Pacientes</h3><input type="text" class="form-control w-25" id="busqPac" onkeyup="buscar('busqPac','tabla-pac')" placeholder="Buscar..."></div>
                <div class="card-panel p-0 overflow-hidden">
                    <table class="table table-custom table-hover m-0">
                        <thead><tr><th>Paciente</th><th>Cédula</th><th>Estadío</th><th>Acciones</th></tr></thead>
                        <tbody id="tabla-pac"></tbody>
                    </table>
                </div>
            </div>

            <div id="recetas-section" style="display:none;">
                <h3>Envío de Resultados y Recetas</h3>
                <div class="card-panel mt-3">
                    <form action="/api/enviar-receta" method="POST" enctype="multipart/form-data">
                        <div class="row g-3">
                            <div class="col-md-6"><label>Paciente</label><select class="form-select" id="select-pac-receta" name="paciente_id"></select></div>
                            <div class="col-md-6"><label>Tipo Documento</label><select class="form-select" name="tipo"><option value="receta">Receta Médica</option><option value="orden">Orden Exámenes</option><option value="informe">Informe Médico</option></select></div>
                            <div class="col-12"><label>Observaciones</label><textarea class="form-control" name="descripcion" rows="2"></textarea></div>
                            <div class="col-12"><label>Adjunto</label><input type="file" class="form-control" name="archivo" required></div>
                            <div class="col-12"><button class="btn btn-turquesa w-100">Enviar Ahora</button></div>
                        </div>
                    </form>
                </div>
                <h5 class="mt-4">Historial de Envíos</h5>
                <div class="card-panel p-0"><table class="table table-custom"><thead><tr><th>Fecha</th><th>Paciente</th><th>Tipo</th><th>Archivo</th></tr></thead><tbody id="tabla-historial-recetas"></tbody></table></div>
            </div>

            <div id="nuevo-personal-section" style="display:none;">
                <h3>Alta de Personal</h3>
                <div class="card-panel mt-3">
                    <form onsubmit="registrarPersonal(event)" autocomplete="off">
                        <div class="row g-3">
                            <div class="col-md-6"><label>Nombre</label><input type="text" class="form-control" name="nombre" required></div>
                            <div class="col-md-6"><label>Cédula</label><input type="text" class="form-control" name="cedula" required></div>
                            <div class="col-md-6">
                                <label class="fw-bold" style="color:var(--accent)">Cargo</label>
                                <select class="form-select" name="cargo" id="selectCargo" onchange="verificarCargo()" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Nefrólogo">Nefrólogo</option>
                                    <option value="Médico General">Médico General</option>
                                    <option value="Nutricionista">Nutricionista</option>
                                    <option value="Psicólogo">Psicólogo</option>
                                    <option value="Internista">Internista</option>
                                    <option value="Enfermera">Enfermera</option>
                                    <option value="Tecnico">Técnico</option>
                                    <option value="Administrativo">Administrativo</option>
                                </select>
                            </div>
                            <div class="col-md-6"><label>Email</label><input type="email" class="form-control" name="email" required></div>
                            <div class="col-md-4"><label>Teléfono</label><input type="tel" class="form-control" name="telefono" required></div>
                            <div class="col-md-4"><label>Horario</label><input type="text" class="form-control" name="horario" placeholder="Ej: 7am - 1pm" required></div>
                            <div class="col-md-4"><label>Nacimiento</label><input type="date" class="form-control" name="fecha_nacimiento" required></div>
                            
                            <div class="col-12" id="password-container" style="display:none;">
                                <div class="p-3 bg-light border rounded">
                                    <label class="text-danger fw-bold"><i class="bi bi-lock"></i> Contraseña de Acceso</label>
                                    <input type="password" class="form-control mt-1" name="password">
                                </div>
                            </div>
                            <div class="col-12"><button class="btn btn-turquesa w-100 mt-2">Registrar Colaborador</button></div>
                        </div>
                    </form>
                </div>
            </div>

            <div id="lista-personal-section" style="display:none;">
                <div class="d-flex justify-content-between mb-3"><h3>Nómina de Colaboradores</h3><input type="text" class="form-control w-25" id="busqPers" onkeyup="buscar('busqPers','tabla-pers')" placeholder="Buscar..."></div>
                <div class="card-panel p-0 overflow-hidden">
                    <table class="table table-custom table-hover m-0">
                        <thead><tr><th>Nombre</th><th>Cargo</th><th>Teléfono</th><th>Horario</th><th>Acciones</th></tr></thead>
                        <tbody id="tabla-pers"></tbody>
                    </table>
                </div>
            </div>

            <div id="inventario-section" style="display:none;">
                <div class="d-flex justify-content-between mb-3"><h3>Inventario de Equipos</h3><button class="btn btn-turquesa" data-bs-toggle="modal" data-bs-target="#modalEquipo">+ Nuevo Equipo</button></div>
                <div class="card-panel p-0 overflow-hidden">
                    <table class="table table-custom table-hover m-0"><thead><tr><th>Equipo</th><th>Serial</th><th>Ubicación</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tabla-inv"></tbody></table>
                </div>
            </div>
        </main>
    </div>
</div>

<div class="modal fade" id="modalEquipo" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Equipo</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form onsubmit="registrarEquipo(event)"><div class="mb-2"><label>Nombre</label><input type="text" class="form-control" name="nombre" required></div><div class="mb-2"><label>Serial</label><input type="text" class="form-control" name="serial" required></div><div class="mb-2"><label>Ubicación</label><input type="text" class="form-control" name="ubicacion"></div><div class="mb-3"><label>Estado</label><select class="form-select" name="estado"><option>Operativo</option><option>Dañado</option></select></div><button class="btn btn-turquesa w-100">Guardar</button></form></div></div></div></div>

<div class="modal fade" id="modalVerPaciente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ficha Técnica del Paciente</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center mb-4">
                    <div class="bg-light rounded-circle p-3 me-3"><i class="bi bi-person-fill fs-1 text-secondary"></i></div>
                    <div>
                        <h3 class="m-0 fw-bold text-primary" id="vp_nom"></h3>
                        <span id="vp_est" class="badge bg-warning text-dark mt-1"></span>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card p-3 h-100 border-0 bg-light">
                            <h6 class="text-uppercase text-muted small fw-bold mb-3">Datos Personales</h6>
                            <span class="detail-label">Cédula</span><span class="detail-value" id="vp_ced"></span>
                            <span class="detail-label">Email</span><span class="detail-value" id="vp_email"></span>
                            <span class="detail-label">Teléfono</span><span class="detail-value" id="vp_tel"></span>
                            <span class="detail-label">Fecha Nacimiento</span><span class="detail-value" id="vp_nac"></span>
                            <span class="detail-label">Sexo</span><span class="detail-value" id="vp_sexo"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3 h-100 border-0 bg-light">
                            <h6 class="text-uppercase text-muted small fw-bold mb-3">Datos Clínicos & Ubicación</h6>
                            <span class="detail-label">Urea / Creatinina</span><span class="detail-value" id="vp_vals"></span>
                            <span class="detail-label">Dirección</span><span class="detail-value" id="vp_dir"></span>
                            <span class="detail-label">Contacto Emergencia</span><span class="detail-value text-danger" id="vp_emerg"></span>
                            <span class="detail-label">Comorbilidades / Notas</span>
                            <div class="p-2 bg-white border rounded text-muted small" id="vp_hist" style="height: 80px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarPac" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title text-dark">Editar Paciente</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="ep_id"><div class="row g-2"><div class="col-6"><label>Nombre</label><input type="text" class="form-control" id="ep_nom"></div><div class="col-6"><label>Email</label><input type="text" class="form-control" id="ep_mail"></div><div class="col-6"><label>Cédula</label><input type="text" class="form-control" id="ep_ced"></div><div class="col-6"><label>Nacimiento</label><input type="date" class="form-control" id="ep_nac"></div><div class="col-4"><label>Urea</label><input type="number" class="form-control" id="ep_urea"></div><div class="col-4"><label>Crea</label><input type="number" class="form-control" id="ep_crea"></div><div class="col-4"><label>Estadío</label><input type="text" class="form-control" id="ep_est"></div><div class="col-12"><label>Notas</label><textarea class="form-control" id="ep_not"></textarea></div></div><button class="btn btn-turquesa w-100 mt-3" onclick="guardarEditPac()">Guardar Cambios</button></div></div></div></div>

<div class="modal fade" id="modalVerPersonal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle Colaborador</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div class="bg-light rounded-circle d-inline-flex p-3 mb-3"><i class="bi bi-person-badge fs-1 text-success"></i></div>
                <h4 id="vpe_nom" class="fw-bold text-dark mb-1"></h4>
                <span id="vpe_car" class="badge bg-success fs-6 mb-4"></span>
                
                <div class="text-start bg-light p-3 rounded">
                    <div class="mb-2"><span class="detail-label">Cédula:</span> <span id="vpe_ced" class="text-dark"></span></div>
                    <div class="mb-2"><span class="detail-label">Email:</span> <span id="vpe_mail" class="text-dark"></span></div>
                    <div class="mb-2"><span class="detail-label">Teléfono:</span> <span id="vpe_tel" class="text-dark"></span></div>
                    <div class="mb-2"><span class="detail-label">Horario:</span> <span id="vpe_hor" class="text-dark"></span></div>
                    <div><span class="detail-label">Nacimiento:</span> <span id="vpe_nac" class="text-dark"></span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarPers" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title text-dark">Editar Colaborador</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="epe_id"><label>Nombre</label><input type="text" class="form-control mb-2" id="epe_nom"><label>Cargo</label><input type="text" class="form-control mb-2" id="epe_car"><label>Email</label><input type="text" class="form-control mb-2" id="epe_mail"><label>Teléfono</label><input type="text" class="form-control mb-2" id="epe_tel"><label>Horario</label><input type="text" class="form-control mb-2" id="epe_hor"><button class="btn btn-turquesa w-100 mt-3" onclick="guardarEditPers()">Actualizar</button></div></div></div></div>

<div class="modal fade" id="modalControlDialisis" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-white border-bottom">
                <h5 class="modal-title fw-bold text-danger"><i class="bi bi-clipboard2-pulse-fill"></i> Ficha Técnica de Diálisis</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" style="background-color: #fafafa;">
                <div class="text-center mb-4">
                    <h3 id="fd_nombre" class="fw-bold text-dark"></h3>
                    <div class="badge bg-danger text-white px-3 py-2">PACIENTE RENAL CRÓNICO (ESTADIO 5)</div>
                </div>
                <div class="row g-4">
                    <div class="col-md-6"><h6 class="section-title">ANÁLISIS BIOQUÍMICO</h6><div class="row g-2"><div class="col-6"><span class="label-clinical">Urea (mg/dL)</span><span class="data-value text-center" id="fd_urea"></span></div><div class="col-6"><span class="label-clinical">Creatinina (mg/dL)</span><span class="data-value text-center" id="fd_crea"></span></div><div class="col-4"><span class="label-clinical">Calcio</span><span class="data-value text-center" id="fd_calcio"></span></div><div class="col-4"><span class="label-clinical">Fósforo</span><span class="data-value text-center" id="fd_fosforo"></span></div><div class="col-4"><span class="label-clinical">PTH</span><span class="data-value text-center" id="fd_pth"></span></div></div></div>
                    <div class="col-md-6"><h6 class="section-title">PROTOCOLO DE DIÁLISIS</h6><div class="mb-2"><span class="label-clinical">Máquina / Filtro / Perfil</span><span class="data-value" id="fd_maquina" style="min-height: 40px;"></span></div><div class="mb-2"><span class="label-clinical">Notas Clínicas / Comorbilidades</span><div class="data-value" id="fd_notas" style="min-height: 60px; font-style: italic;"></div></div></div>
                </div>
                <div class="alert alert-info mt-3 d-flex align-items-center"><i class="bi bi-info-circle-fill me-2 fs-4"></i><small>Nota: Datos de Peso Seco/Presión deben registrarse en historial.</small></div>
            </div>
            <div class="modal-footer bg-white"><button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button><button class="btn btn-danger" onclick="imprimirFicha()"><i class="bi bi-printer-fill"></i> Imprimir</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let dataPacientes=[], dataPersonal=[], dataInventario=[];
    let chartSexo, chartEdad, chartEstadio, chartHistoria;

    document.addEventListener('DOMContentLoaded', () => {
        cargarDatosEstadisticos();
        cargarPersonal();
        cargarInventario();
        cargarHistorialRecetas();
    });

    function toggleMenu() { document.querySelector('.sidebar').classList.toggle('show'); document.getElementById('mobileOverlay').classList.toggle('show'); }

    function showSection(id, el) {
        ['estadisticas','registro-paciente','lista-pacientes','recetas','nuevo-personal','lista-personal','inventario','dialisis'].forEach(s => { 
            const d = document.getElementById(s+'-section'); if(d) d.style.display='none'; 
        });
        document.getElementById(id+'-section').style.display='block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        if(el) el.classList.add('active');

        if(id==='estadisticas') {
            // Renderizar gráfica SOLO cuando la sección es visible
            setTimeout(renderCharts, 200);
        }
        if(id==='dialisis') cargarTablaDialisis();
        if(window.innerWidth <= 768) toggleMenu();
    }

    function verificarCargo() {
        const c = document.getElementById('selectCargo').value;
        const req = ['Nefrólogo','Internista','Nutricionista','Psicólogo','Médico General'].includes(c);
        document.getElementById('password-container').style.display = req ? 'block' : 'none';
        const pass = document.querySelector('input[name="password"]');
        if(req) pass.setAttribute('required','true'); else pass.removeAttribute('required');
    }

    // --- CARGAS DE DATOS ---
    function cargarDatosEstadisticos() {
        fetch('/api/pacientes-lista').then(r=>r.json()).then(d => {
            dataPacientes = d;
            
            let html = '', sel = '<option>Seleccionar...</option>';
            d.forEach(p => {
                let est = p.estadio_erc ? p.estadio_erc.toLowerCase() : '';
                let isIRC = est.includes('5') || est.includes('dialisis') || est.includes('diálisis') || est.includes('terminal') || est.includes('irc');
                let badge = isIRC ? 'bg-danger' : 'bg-success';
                
                html += `<tr>
                    <td class="fw-bold">${p.nombre_completo}</td>
                    <td>${p.cedula}</td>
                    <td><span class="badge ${badge}">${p.estadio_erc||'--'}</span></td>
                    <td class="text-end">
                        <i class="bi bi-eye-fill action-btn text-view" onclick="verPaciente(${p.id})"></i>
                        <i class="bi bi-pencil-fill action-btn text-edit" onclick="editarPac(${p.id})"></i>
                        <i class="bi bi-trash-fill action-btn text-delete" onclick="borrar('paciente',${p.id})"></i>
                    </td>
                </tr>`;
                sel += `<option value="${p.id}">${p.nombre_completo}</option>`;
            });
            document.getElementById('tabla-pac').innerHTML = html;
            document.getElementById('select-pac-receta').innerHTML = sel;
            
            if(document.getElementById('estadisticas-section').style.display !== 'none') renderCharts();
        });
    }

    // --- FUNCIÓN VER PACIENTE COMPLETA ---
    function verPaciente(id) {
        let p = dataPacientes.find(x => x.id == id);
        if(!p) return;
        document.getElementById('vp_nom').innerText = p.nombre_completo;
        document.getElementById('vp_ced').innerText = p.cedula;
        document.getElementById('vp_est').innerText = p.estadio_erc || 'Sin Clasificar';
        document.getElementById('vp_email').innerText = p.email || 'No registrado';
        document.getElementById('vp_tel').innerText = p.telefono || 'No registrado';
        document.getElementById('vp_nac').innerText = p.fecha_nacimiento ? new Date(p.fecha_nacimiento).toLocaleDateString() : '-';
        document.getElementById('vp_sexo').innerText = p.sexo || '-';
        document.getElementById('vp_vals').innerText = `Urea: ${p.urea||'-'} | Creatinina: ${p.creatinina||'-'}`;
        document.getElementById('vp_dir').innerText = p.direccion || 'No registrada';
        document.getElementById('vp_emerg').innerText = p.contacto_emergencia || 'No registrado';
        document.getElementById('vp_hist').innerText = p.comorbilidades || 'Sin notas clínicas';
        
        new bootstrap.Modal(document.getElementById('modalVerPaciente')).show();
    }

    // --- FUNCIÓN VER PERSONAL COMPLETA ---
    function verPers(id) {
        let p = dataPersonal.find(x => x.id == id);
        if(!p) return;
        document.getElementById('vpe_nom').innerText = p.nombre_completo;
        document.getElementById('vpe_car').innerText = p.cargo;
        document.getElementById('vpe_mail').innerText = p.email;
        document.getElementById('vpe_tel').innerText = p.telefono;
        document.getElementById('vpe_hor').innerText = p.horario;
        document.getElementById('vpe_ced').innerText = p.cedula || 'No registrada';
        document.getElementById('vpe_nac').innerText = p.fecha_nacimiento ? new Date(p.fecha_nacimiento).toLocaleDateString() : '-';
        
        new bootstrap.Modal(document.getElementById('modalVerPersonal')).show();
    }

    function cargarTablaDialisis() {
        const criticos = dataPacientes.filter(p => {
            let est = p.estadio_erc ? p.estadio_erc.toLowerCase() : '';
            return est.includes('5') || est.includes('dialisis') || est.includes('diálisis') || est.includes('irc');
        });

        let html = criticos.length ? '' : '<tr><td colspan="4" class="text-center text-muted">Sin pacientes en diálisis.</td></tr>';
        criticos.forEach(p => {
            html += `<tr><td class="fw-bold text-danger">${p.nombre_completo}</td><td>${p.cedula}</td><td>Urea: ${p.urea} | Crea: ${p.creatinina}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger fw-bold" onclick="verFichaDialisis(${p.id})"><i class="bi bi-clipboard-data"></i> Ver Ficha</button></td></tr>`;
        });
        document.getElementById('tabla-dialisis').innerHTML = html;
    }

    function verFichaDialisis(id) {
        let p = dataPacientes.find(x => x.id == id);
        let historia = {};
        try { historia = typeof p.historia_completa === 'string' ? JSON.parse(p.historia_completa) : (p.historia_completa || {}); } catch(e) {}

        document.getElementById('fd_nombre').innerText = p.nombre_completo;
        document.getElementById('fd_urea').innerText = p.urea || '-';
        document.getElementById('fd_crea').innerText = p.creatinina || '-';
        document.getElementById('fd_calcio').innerText = historia.lab_calcio || 'No reg.';
        document.getElementById('fd_fosforo').innerText = historia.lab_fosforo || 'No reg.';
        document.getElementById('fd_pth').innerText = historia.lab_pth || 'No reg.';
        document.getElementById('fd_maquina').innerText = historia.trat_dialisis || 'No registrado.';
        document.getElementById('fd_notas').innerText = p.comorbilidades || 'Sin notas.';

        new bootstrap.Modal(document.getElementById('modalControlDialisis')).show();
    }

    function imprimirFicha() { window.print(); }

    function cargarPersonal() {
        fetch('/api/personal-lista').then(r=>r.json()).then(d => {
            dataPersonal = d;
            let html = '';
            d.forEach(u => {
                html += `<tr><td>${u.nombre_completo}</td><td><span class="badge bg-secondary">${u.cargo}</span></td><td>${u.telefono||''}</td><td>${u.horario||''}</td>
                <td>
                    <i class="bi bi-eye-fill action-btn text-view" onclick="verPers(${u.id})"></i>
                    <i class="bi bi-pencil-fill action-btn text-edit" onclick="editarPers(${u.id})"></i>
                    <i class="bi bi-trash-fill action-btn text-delete" onclick="borrar('personal',${u.id})"></i>
                </td></tr>`;
            });
            document.getElementById('tabla-pers').innerHTML = html;
        });
    }

    // --- GRÁFICOS REALES (CURVA CRECIMIENTO CORREGIDA) ---
    function renderCharts() {
        if(!dataPacientes || dataPacientes.length === 0) return;
        
        // 1. SEXO
        let m=0, f=0; dataPacientes.forEach(p=>p.sexo==='Masculino'?m++:f++);
        if(chartSexo) chartSexo.destroy();
        chartSexo = new Chart(document.getElementById('chartSexo'), { type:'pie', data:{labels:['Masculino','Femenino'], datasets:[{data:[m,f], backgroundColor:['#004d40','#26a69a']}]}, options:{maintainAspectRatio:false} });
        
        // 2. ESTADIOS
        let e1=0, e2=0, e3=0, e4=0, e5=0;
        dataPacientes.forEach(p => {
           let est = p.estadio_erc ? p.estadio_erc.toLowerCase() : '';
           if(est.includes('1')) e1++; 
           else if(est.includes('2')) e2++; 
           else if(est.includes('3')) e3++; 
           else if(est.includes('4')) e4++; 
           else if(est.includes('5') || est.includes('dialisis') || est.includes('diálisis') || est.includes('irc')) e5++;
        });
        
        if(chartEstadio) chartEstadio.destroy();
        chartEstadio = new Chart(document.getElementById('chartEstadio'), { 
            type:'doughnut', 
            data:{labels:['E1','E2','E3','E4','IRC'], datasets:[{data:[e1,e2,e3,e4,e5], backgroundColor:['#b2dfdb','#80cbc4','#4db6ac','#26a69a','#b71c1c']}]}, 
            options:{maintainAspectRatio:false} 
        });

        // 3. EDAD
        let g1=0, g2=0, g3=0;
        const currentYear = new Date().getFullYear();
        dataPacientes.forEach(p => {
            if(p.fecha_nacimiento) {
                let age = currentYear - new Date(p.fecha_nacimiento).getFullYear();
                if(age <= 20) g1++; else if(age <= 50) g2++; else g3++;
            }
        });
        if(chartEdad) chartEdad.destroy();
        chartEdad = new Chart(document.getElementById('chartEdad'), { type:'bar', data:{labels:['0-20','21-50','51+'], datasets:[{label:'Edad', data:[g1,g2,g3], backgroundColor:'#00897b'}]}, options:{maintainAspectRatio:false} });
        
        // 4. CURVA DE CRECIMIENTO (FORZADA DESDE CERO)
        let sorted = [...dataPacientes].sort((a, b) => a.id - b.id);
        let labels = ['Inicio'], dERC = [0], dIRC = [0]; // PUNTO INICIAL (0,0)
        let accERC = 0, accIRC = 0;

        sorted.forEach((p, i) => {
            labels.push(`P${i + 1}`);
            let est = p.estadio_erc ? p.estadio_erc.toLowerCase() : '';
            if(est.includes('5') || est.includes('dialisis') || est.includes('diálisis') || est.includes('irc')) {
                accIRC++;
            } else {
                accERC++;
            }
            dERC.push(accERC);
            dIRC.push(accIRC);
        });

        if(chartHistoria) chartHistoria.destroy();
        chartHistoria = new Chart(document.getElementById('chartHistoria'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'ERC (Estadios 1-4)', data: dERC, borderColor: '#26a69a', tension: 0.3, fill: false },
                    { label: 'IRC (Diálisis)', data: dIRC, borderColor: '#b71c1c', tension: 0.3, fill: false }
                ]
            },
            options: { 
                maintainAspectRatio: false, 
                responsive: true,
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: 'Total Pacientes' },
                        ticks: { stepSize: 1 }
                    } 
                } 
            }
        });
    }

    function editarPac(id){let p=dataPacientes.find(x=>x.id==id);document.getElementById('ep_id').value=p.id;document.getElementById('ep_nom').value=p.nombre_completo;document.getElementById('ep_ced').value=p.cedula;document.getElementById('ep_mail').value=p.email;document.getElementById('ep_nac').value=p.fecha_nacimiento?p.fecha_nacimiento.split('T')[0]:'';document.getElementById('ep_urea').value=p.urea;document.getElementById('ep_crea').value=p.creatinina;document.getElementById('ep_est').value=p.estadio_erc;document.getElementById('ep_not').value=p.comorbilidades;new bootstrap.Modal(document.getElementById('modalEditarPac')).show();}
    function guardarEditPac(){let id=document.getElementById('ep_id').value,b={nombre:document.getElementById('ep_nom').value,email:document.getElementById('ep_mail').value,cedula:document.getElementById('ep_ced').value,fecha_nacimiento:document.getElementById('ep_nac').value,urea:document.getElementById('ep_urea').value,creatinina:document.getElementById('ep_crea').value,estadio:document.getElementById('ep_est').value,comorbilidades:document.getElementById('ep_not').value};fetch(`/api/paciente/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)}).then(r=>r.json()).then(d=>{if(d.success){Swal.fire('Guardado','','success');location.reload();}});}
    function editarPers(id){let p=dataPersonal.find(x=>x.id==id);document.getElementById('epe_id').value=p.id;document.getElementById('epe_nom').value=p.nombre_completo;document.getElementById('epe_car').value=p.cargo;document.getElementById('epe_mail').value=p.email;document.getElementById('epe_tel').value=p.telefono;document.getElementById('epe_hor').value=p.horario;new bootstrap.Modal(document.getElementById('modalEditarPers')).show();}
    function guardarEditPers(){let id=document.getElementById('epe_id').value,b={nombre:document.getElementById('epe_nom').value,cargo:document.getElementById('epe_car').value,email:document.getElementById('epe_mail').value,telefono:document.getElementById('epe_tel').value,horario:document.getElementById('epe_hor').value,cedula:dataPersonal.find(x=>x.id==id).cedula,fecha_nacimiento:dataPersonal.find(x=>x.id==id).fecha_nacimiento};fetch(`/api/personal/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)}).then(r=>r.json()).then(d=>{if(d.success){Swal.fire('Guardado','','success');location.reload();}});}
    
    function registrarPaciente(e){e.preventDefault();postData('/register-patient',new FormData(e.target));}
    function registrarPersonal(e){e.preventDefault();postData('/register-staff',new FormData(e.target));}
    function registrarEquipo(e){e.preventDefault();postData('/register-equipment',new FormData(e.target));}
    function postData(u,f){fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(Object.fromEntries(f.entries()))}).then(r=>r.json()).then(d=>{if(d.success){Swal.fire('Éxito','','success');location.reload();}else Swal.fire('Error',d.error,'error');});}
    function borrar(t,i){Swal.fire({title:'¿Borrar?',showCancelButton:true}).then(r=>{if(r.isConfirmed)fetch(`/api/${t}/${i}`,{method:'DELETE'}).then(()=>{location.reload()})});}
    function cargarInventario(){fetch('/api/inventario-lista').then(r=>r.json()).then(d=>{let h='';d.forEach(e=>{h+=`<tr><td>${e.nombre}</td><td>${e.serial}</td><td>${e.ubicacion}</td><td>${e.estado}</td><td><i class="bi bi-trash text-danger action-btn" onclick="borrar('inventario',${e.id})"></i></td></tr>`;});document.getElementById('tabla-inv').innerHTML=h;});}
    function cargarHistorialRecetas(){fetch('/api/historial-archivos').then(r=>r.json()).then(d=>{let h='';d.forEach(x=>{h+=`<tr><td>${new Date(x.fecha_envio).toLocaleDateString()}</td><td>${x.paciente_nombre}</td><td>${x.tipo_archivo}</td><td><a href="${x.ruta_archivo}" target="_blank">Ver</a></td></tr>`;});document.getElementById('tabla-historial-recetas').innerHTML=h;});}
    function calcTFG(){let e=document.getElementById('inputEdad').value,c=document.getElementById('inputCreatinina').value,s=document.getElementById('inputSexo').value;if(e&&c){let v=186*Math.pow(c,-1.154)*Math.pow(e,-0.203)*(s==='Femenino'?0.742:1);document.getElementById('resTFG').innerText=v.toFixed(1);document.getElementById('inputEstadio').value=v>=90?'Estadío 1':v>=60?'Estadío 2':v>=30?'Estadío 3':v>=15?'Estadío 4':'Estadío 5';}}
    function buscar(i,t){let v=document.getElementById(i).value.toLowerCase();for(let r of document.getElementById(t).rows)r.style.display=r.innerText.toLowerCase().includes(v)?'':'none';}
</script>

</body>
</html>
